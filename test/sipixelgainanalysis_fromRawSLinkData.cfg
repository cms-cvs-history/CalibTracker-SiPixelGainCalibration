process AnalyzeGainFF = {

######################################################
#
#   By Freya Blekman
#
######################################################
# to change files change the following parameters:
# 1. the input file 
# 2. the calib database tag
# the following wiki page has lists of datasets: 
# https://twiki.cern.ch/twiki/bin/view/CMS/TIF_and_PSI_data
######################################################

######################################################
#  define the number of events to run on (-1 = all)
######################################################

   untracked PSet maxEvents = {untracked int32 input = -1}


#################################
# define any file from disk (prefix: "file:") castor (prefix "rfio:") or other framework supported locations in the fileNames vector:
# WARNING: Currently only supports the reading in of a SINGLE file. This will be fixed once the framework people fix the raw data sources classes.
#################################

   include "IORawData/SiPixelInputSources/data/PixelSLinkDataInputSource.cfi"
   replace PixelSLinkDataInputSource.fileNames = {"rfio:/castor/cern.ch/cms/store/TAC/PIXEL/FPIX/HC+Z1/GainCalibration_298.dmp"}



#############################################
# raw to digi
#############################################

    include "EventFilter/SiPixelRawToDigi/data/SiPixelRawToDigi.cfi"
    replace siPixelDigis.InputLabel = "source"
#############################################
# make sure the error collection is included...
#############################################
    replace siPixelDigis.IncludeErrors = true

#############################################
#   create calibdigis
#############################################

    include "CalibTracker/SiPixelGainCalibration/data/SiPixelCalibDigiProducer.cfi"
    replace siPixelCalibDigis.src = "siPixelDigis"


############################################################
# databases, cabling maps and geometry
############################################################
       

   include "CalibFormats/SiPixelObjects/data/SiPixelCalibConfiguration.cfi"
   replace sipixelcalib_essource.toGet = { 
	{ 
	    string record = "SiPixelCalibConfigurationRcd"
	    # change the tag appropriately. 
	    # This tag string controls which calibration information is used and for now should match the used datafile.
	    string tag = "GainCalibration_298"
	},
	{ # this is cabling information, it contains the cabling map
	    string record = "SiPixelFedCablingMapRcd"
	    string tag = "SiPixelFedCablingMap_v9"
	}
    }

    include "Geometry/TrackerSimData/data/trackerSimGeometryXML.cfi"
    include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
############################################################  
# Output database!!! Beware as this is a mysql db by default. 
# This means it is incompatible with the oracle db used for the
# cabling map and calibration configuration. Modify and only 
# for expert use in combination with storage in an oracle db and
# the activation of the database storage flag in the SiPixelGainCalibration
# object
############################################################       

    include "CondTools/SiPixel/data/SiPixelGainCalibrationService.cfi"

    service = PoolDBOutputService {
	string timetype = "runnumber"
	string connect = "sqlite_file:prova_rawdata.db"
	VPSet toPut={ {string record= "SiPixelGainCalibrationRcd" string tag ="GainCalib_v2_test"} }   
	PSet DBParameters = { 
	    untracked string authenticationPath = "./"  
	    untracked int32 messageLevel = 1
     	}
    }

############################################################
# include DQM services
############################################################
 
service = DaqMonitorROOTBackEnd{}

############################################################
# include the settings for sipixelgaincalibrationanalysis.cfi
############################################################
 
    include "CalibTracker/SiPixelGainCalibration/data/SiPixelGainCalibrationAnalysis.cfi"
    replace siPixelGainCalibrationAnalysis.outputFileName="test_ffgain.root"
    replace siPixelGainCalibrationAnalysis.DetSetVectorSiPixelCalibDigiTag=siPixelCalibDigis
    replace siPixelGainCalibrationAnalysis.minChi2ProbforHistSave=0.000001

############################################################
# include the message logger
############################################################
 
    include "FWCore/MessageService/data/MessageLogger.cfi"
    replace MessageLogger.cout =  {      
	untracked string threshold = "ERROR"    
	#   untracked PSet default = { untracked int32 limit = 10000000 }  
	untracked PSet FwkReport =  { 
	    untracked int32 limit = 1000 
	    untracked int32 reportEvery = 500 
	}
#	untracked PSet Root_Information = { untracked int32 limit = 0 }
    }

############################################################
# uncomment these if you want to do timing studies...
############################################################

#    service = Timing {}

#module contentdump  = EventContentAnalyzer{}


############################################################
# define the various paths
############################################################
 
    path p = {siPixelDigis,siPixelCalibDigis, siPixelGainCalibrationAnalysis} 
#    endpath ep = {contentdump}
}
