process AnalyzeGainFF = {

######################################################
#
#   By Freya Blekman
#
######################################################
# to change files change the following parameters:
# 1. the input file 
# 2. the calib database tag
# the following wiki page has lists of datasets: 
# https://twiki.cern.ch/twiki/bin/view/CMS/TIF_and_PSI_data
######################################################

######################################################
#  define the number of events to run on (-1 = all)
######################################################

   untracked PSet maxEvents = {untracked int32 input = -1}

############################################################
# define input file
############################################################
       
    source = PoolSource 
    { 
	# replace 'myfile.root' with the source file you want to use
	untracked vstring fileNames = {"file:calibdigis.root"}
    }

############################################################
# databases, cabling maps and geometry
############################################################
       

   include "CondTools/SiPixel/data/SiPixelCalibConfiguration.cfi"
   replace sipixelcalib_essource.toGet = { 
	{ 
	    string record = "SiPixelCalibConfigurationRcd"
	    # change the tag appropriately. 
	    # This tag string controls which calibration information is used and for now should match the used datafile.
	    string tag = "GainCalibration_298"
	},
	{ # this is cabling information, it contains the cabling map
	    string record = "SiPixelFedCablingMapRcd"
	    string tag = "SiPixelFedCablingMap_v9"
	}
    }

    include "Geometry/TrackerSimData/data/trackerSimGeometryXML.cfi"
    include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
############################################################  
# Output database!!! Beware as this is a mysql db by default. 
# This means it is incompatible with the oracle db used for the
# cabling map and calibration configuration. Modify and only 
# for expert use in combination with storage in an oracle db and
# the activation of the database storage flag in the SiPixelGainCalibration
# object
############################################################       

    include "CondTools/SiPixel/data/SiPixelGainCalibrationService.cfi"

    service = PoolDBOutputService {
#	string connect = "oracle://cms_orcoff_int2r/CMS_COND_PIXEL"
	string connect = "sqlite_file:prova_rawdata.db"
	VPSet toPut={ 
	    {string record= "SiPixelGainCalibrationRcd" string tag ="GainCalib_freyatest"},  
	    {string record= "SiPixelGainCalibrationForHLTRcd" string tag ="GainCalib_freyatest"},
	    {string record= "SiPixelGainCalibrationOfflineRcd" string tag ="GainCalib_freyatest"}
	}   
	PSet DBParameters = { 
	    untracked string authenticationPath = "./"  
	    untracked int32 messageLevel = 1
     	}
    }

############################################################
# include DQM services
############################################################
 
    include "DQMServices/Core/data/DQM.cfg"

############################################################
# include the settings for sipixelgaincalibrationanalysis.cfi
############################################################
 
    include "CalibTracker/SiPixelGainCalibration/data/SiPixelGainCalibrationAnalysis.cfi"
    replace siPixelGainCalibrationAnalysis.outputFileName="test_ffgain.root"
    replace siPixelGainCalibrationAnalysis.DetSetVectorSiPixelCalibDigiTag=siPixelCalibDigis
    replace siPixelGainCalibrationAnalysis.minChi2ProbforHistSave=0.000001
#    replace siPixelGainCalibrationAnalysis.savePixelLevelHists = true

############################################################
# include the message logger
############################################################
 
    include "FWCore/MessageService/data/MessageLogger.cfi"
    replace MessageLogger.cout =  {      
	untracked string threshold = "INFO"    
	#   untracked PSet default = { untracked int32 limit = 10000000 }  
	untracked PSet FwkReport =  { 
	    untracked int32 limit = 100000 
	    untracked int32 reportEvery = 2000 
	}
	untracked PSet Root_Information = { untracked int32 limit = 0 }
    }

############################################################
# uncomment these if you want to do timing studies...
############################################################

#    service = Timing {}

#module contentdump  = EventContentAnalyzer{}


############################################################
# define the various paths
############################################################
 
    path p = {siPixelGainCalibrationAnalysis} 
#    endpath ep = {contentdump}
}
