process PIXELGAINCALIB = 
{
######################################################
#
#   By Freya Blekman
#
######################################################
# to change files change the following parameters:
# 1. the input file (PixelSLinkDataInputSource.fileNames parameter)
# 2. the calib.dat file location (SiPixelGainCalibrationAnalysis.inputFileName parameter)
# the following wiki page has lists of datasets: 
# https://twiki.cern.ch/twiki/bin/view/CMS/TIF_and_PSI_data
######################################################

######################################################
#  define the number of events to run on (-1 = all)
   untracked PSet maxEvents = {untracked int32 input = -1}

######################################################
#use the settings for the calibration database access from the CondTools package
   include "CondTools/SiPixel/data/SiPixelGainCalibrationService.cfi"

   # Input source
   include "IORawData/SiPixelInputSources/data/PixelSLinkDataInputSource.cfi"
   replace PixelSLinkDataInputSource.fedid=33
#############################################
#   definition of the input file that contains the raw data
#  see https://twiki.cern.ch/twiki/bin/view/CMS/TIF_and_PSI_data for location of files
   replace PixelSLinkDataInputSource.fileNames={'rfio:/castor/cern.ch/cms/store/TAC/PIXEL/FPIX/HC-Z1/HD1/Blades01_02_03/GainCalibration.23Aug07_1851.dmp'}

   include "CalibTracker/SiPixelGainCalibration/data/SiPixelGainCalibrationAnalysis.cfi"
   replace SiPixelGainCalibrationAnalysis.src = "siPixelDigis"
   replace SiPixelGainCalibrationAnalysis.dummyData = false
#################################################
#  definition of the calib.dat file. 
#  Best not to be ran straight from castor, castor is not very good for small files
#  to copy a file out of castor use the rfcp command: 
#  syntax: rfcp /castor/cern.ch/afile ./myfile
#  see https://twiki.cern.ch/twiki/bin/view/CMS/TIF_and_PSI_data for location of calib.dat files in afs 
   replace SiPixelGainCalibrationAnalysis.inputFileName= "/afs/cern.ch/cms/Tracker/Pixel/forward/FPIX/HC-Z1/HD1/Blades01_02_03/calib.GainCalibration.23Aug07_1851.dat"


############################################################
#  this variable defines the name of the output root file...

   service = TFileService {    string fileName = "histograms_gaincalib_fromrawdata.root" }	
	
###########################do not edit unless you're an expert #############################################
#  all other stuff needed....
	
include "CalibTracker/SiPixelGainCalibration/data/fromRawSlinkData.cff"

   # Message Logger
#   include "FWCore/MessageLogger/data/MessageLogger.cfi"
#   or use your own 
   service = MessageLogger {	
	untracked vstring destinations = {"cout"}
	untracked PSet cout = {untracked string threshold = "ERROR"}
	untracked PSet default = {untracked int32 limit = 10} # surpresses error messages in case of corrupt data files used as input for RawToDigi conversion
   }


# the database output
  service = PoolDBOutputService {
    string timetype = "runnumber"
    string connect = "sqlite_file:prova_rawdata.db"
    untracked string catalog = "xmlcatalog_file:prova_dbcatalog_rawdata.xml"
    VPSet toPut={ {string record= "SiPixelGainCalibrationRcd" string tag ="mytest_p"} } 
    PSet DBParameters = { 
	untracked string authenticationPath = "./"  
	untracked int32 messageLevel = 1
	untracked bool loadBlobStreamer = true
	}
  }


   # module execution
   path p = { siPixelDigis, SiPixelGainCalibrationAnalysis }
}
